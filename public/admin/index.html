<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Gi√†y D√©p H∆∞∆°ng Nh·ªõ</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="admin-logo">üëü Admin Panel</div>
            <nav class="admin-nav">
                <a href="/admin/" class="active"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> ƒê∆°n H√†ng</a>
                <a href="/admin/products.html"><i class="fas fa-box"></i> S·∫£n Ph·∫©m</a>
                <a href="/admin/discounts.html"><i class="fas fa-tags"></i> M√£ Gi·∫£m Gi√°</a>
                <a href="/admin/users.html"><i class="fas fa-users"></i> Ng∆∞·ªùi D√πng</a>
                <a href="/"><i class="fas fa-store"></i> Xem Shop</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <h1>Dashboard</h1>
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notif-count" style="display:none">0</span>
                    <div class="notification-dropdown" id="notif-dropdown">
                        <div
                            style="padding:1rem;border-bottom:1px solid #eee;display:flex;justify-content:space-between">
                            <strong>ƒê∆°n h√†ng m·ªõi</strong>
                            <a href="#" onclick="markAllRead()" style="color:var(--primary)">ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc</a>
                        </div>
                        <div id="notif-list"></div>
                    </div>
                </div>
            </div>

            <div class="admin-cards">
                <div class="admin-card">
                    <div class="admin-card-icon orders"><i class="fas fa-shopping-cart"></i></div>
                    <div class="admin-card-info">
                        <h3 id="stat-orders">0</h3>
                        <p>T·ªïng ƒë∆°n h√†ng</p>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="admin-card-icon products"><i class="fas fa-box"></i></div>
                    <div class="admin-card-info">
                        <h3 id="stat-products">0</h3>
                        <p>S·∫£n ph·∫©m</p>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="admin-card-icon users"><i class="fas fa-users"></i></div>
                    <div class="admin-card-info">
                        <h3 id="stat-users">0</h3>
                        <p>Kh√°ch h√†ng</p>
                    </div>
                </div>
                <div class="admin-card">
                    <div class="admin-card-icon revenue"><i class="fas fa-coins"></i></div>
                    <div class="admin-card-info">
                        <h3 id="stat-revenue">0ƒë</h3>
                        <p>Doanh thu th√°ng</p>
                    </div>
                </div>
            </div>

            <div class="admin-table-container">
                <div class="admin-table-header">
                    <h3>ƒê∆°n h√†ng g·∫ßn ƒë√¢y</h3>
                    <a href="/admin/orders.html" class="btn btn-secondary" style="padding:0.5rem 1rem">Xem t·∫•t c·∫£</a>
                </div>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>T·ªïng</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y</th>
                        </tr>
                    </thead>
                    <tbody id="recent-orders"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let notifSound;
        let lastNotifCount = 0;

        async function loadDashboard() {
            if (!isLoggedIn() || !isAdmin()) { window.location.href = '/login.html'; return; }

            try {
                const stats = await adminAPI.getStats();
                document.getElementById('stat-orders').textContent = stats.totalOrders;
                document.getElementById('stat-products').textContent = stats.totalProducts;
                document.getElementById('stat-users').textContent = stats.totalUsers;
                document.getElementById('stat-revenue').textContent = formatPrice(stats.monthlyRevenue);

                const tbody = document.getElementById('recent-orders');
                tbody.innerHTML = stats.recentOrders.map(o => `
          <tr>
            <td>#${o.id}</td>
            <td>${o.User?.name || 'N/A'}</td>
            <td>${formatPrice(o.total)}</td>
            <td><span class="badge badge-${o.status}">${o.status}</span></td>
            <td>${formatDate(o.createdAt)}</td>
          </tr>
        `).join('') || '<tr><td colspan="5" style="text-align:center">Ch∆∞a c√≥ ƒë∆°n h√†ng</td></tr>';
            } catch (error) {
                showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error');
            }
        }

        async function loadNotifications() {
            try {
                const data = await adminAPI.getNotifications();
                const badge = document.getElementById('notif-count');
                const list = document.getElementById('notif-list');

                badge.textContent = data.count;
                badge.style.display = data.count > 0 ? 'block' : 'none';

                if (data.count > lastNotifCount && lastNotifCount > 0) {
                    playNotifSound();
                    showToast(`C√≥ ${data.count - lastNotifCount} ƒë∆°n h√†ng m·ªõi!`, 'success');
                }
                lastNotifCount = data.count;

                list.innerHTML = data.orders.length ? data.orders.map(o => `
          <div class="notification-item unread" onclick="window.location.href='/admin/orders.html'">
            <strong>ƒê∆°n #${o.id}</strong> - ${o.User?.name || 'Kh√°ch'}
            <div style="color:var(--gray);font-size:0.85rem">${formatPrice(o.total)} - ${formatDate(o.createdAt)}</div>
          </div>
        `).join('') : '<div style="padding:2rem;text-align:center;color:var(--gray)">Kh√¥ng c√≥ th√¥ng b√°o m·ªõi</div>';
            } catch (error) { }
        }

        function toggleNotifications() {
            document.getElementById('notif-dropdown').classList.toggle('active');
        }

        async function markAllRead() {
            try {
                await adminAPI.markAllAsRead();
                loadNotifications();
            } catch (error) { }
        }

        function playNotifSound() {
            try {
                if (!notifSound) notifSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbsGEcBj+j2telezsPS5fP3rSTUCYzlsz');
                notifSound.play();
            } catch (e) { }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadNotifications();
            setInterval(loadNotifications, 30000); // Poll every 30 seconds
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.notification-bell')) {
                document.getElementById('notif-dropdown').classList.remove('active');
            }
        });
    </script>
</body>

</html>
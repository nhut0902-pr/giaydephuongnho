<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√£ Gi·∫£m Gi√° - Admin</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="admin-logo">
                <span class="admin-close-btn" onclick="toggleSidebar()"
                    style="display:none;cursor:pointer;margin-right:10px"><i class="fas fa-times"></i></span>
                üëü Admin Panel
            </div>
            <nav class="admin-nav">
                <a href="/admin/"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> ƒê∆°n H√†ng</a>
                <a href="/admin/products.html"><i class="fas fa-box"></i> S·∫£n Ph·∫©m</a>
                <a href="/admin/discounts.html" class="active"><i class="fas fa-tags"></i> M√£ Gi·∫£m Gi√°</a>
                <a href="/admin/flash-sale.html"><i class="fas fa-bolt"></i> Flash Sale</a>
                <a href="/admin/users.html"><i class="fas fa-users"></i> Ng∆∞·ªùi D√πng</a>
                <a href="/"><i class="fas fa-store"></i> Xem Shop</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <div style="display:flex;align-items:center">
                    <i class="fas fa-bars admin-toggle" onclick="toggleSidebar()" style="display:none"></i>
                    <h1>M√£ Gi·∫£m Gi√°</h1>
                </div>
                <button class="btn btn-primary" onclick="showAddModal()"><i class="fas fa-plus"></i> T·∫°o M√£</button>
            </div>

            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>M√£</th>
                            <th>Gi·∫£m (%)</th>
                            <th>ƒê√£ d√πng</th>
                            <th>H·∫øt h·∫°n</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="discounts-tbody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Discount Modal -->
    <div class="modal-overlay" id="discount-modal" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()" style="max-height:90vh;overflow-y:auto">
            <div class="modal-header">
                <h2 id="modal-title">T·∫°o M√£ Gi·∫£m Gi√°</h2><button class="modal-close" onclick="closeModal()"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="discount-form" onsubmit="saveDiscount(event)">
                <input type="hidden" id="discount-id">
                <div class="form-group"><label>M√£ gi·∫£m gi√° *</label><input type="text" id="d-code" required
                        placeholder="VD: SALE50" style="text-transform:uppercase"></div>
                <div class="form-group"><label>Ph·∫ßn trƒÉm gi·∫£m (%) *</label><input type="number" id="d-percent" required
                        min="1" max="100"></div>
                <div class="form-group"><label>Gi√° tr·ªã ƒë∆°n t·ªëi thi·ªÉu (VNƒê)</label><input type="number" id="d-min"
                        min="0" value="0"></div>
                <div class="form-group"><label>Gi·∫£m t·ªëi ƒëa (VNƒê)</label><input type="number" id="d-max" min="0"
                        placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n"></div>
                <div class="form-group"><label>Gi·ªõi h·∫°n l∆∞·ª£t d√πng</label><input type="number" id="d-limit" min="0"
                        placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n"></div>
                <div class="form-group"><label>Ng√†y h·∫øt h·∫°n</label><input type="date" id="d-expiry"></div>

                <!-- New options -->
                <div class="form-group">
                    <label>Lo·∫°i m√£</label>
                    <select id="d-type" onchange="toggleUserSelect()">
                        <option value="public">C√¥ng khai (t·∫•t c·∫£ ai c≈©ng d√πng ƒë∆∞·ª£c)</option>
                        <option value="user_specific">Ri√™ng cho ng∆∞·ªùi d√πng c·ª• th·ªÉ</option>
                    </select>
                </div>
                <div class="form-group" id="user-select-group" style="display:none">
                    <label>Ch·ªçn ng∆∞·ªùi d√πng</label>
                    <select id="d-user"></select>
                </div>
                <div class="form-group"><label><input type="checkbox" id="d-display"> Hi·ªÉn th·ªã banner tr√™n trang
                        ch·ªß</label></div>
                <div class="form-group"><label><input type="checkbox" id="d-notify" checked> G·ª≠i th√¥ng b√°o cho ng∆∞·ªùi
                        d√πng</label></div>
                <div class="form-group"><label><input type="checkbox" id="d-active" checked> K√≠ch ho·∫°t</label></div>
                <button type="submit" class="btn btn-primary btn-block">L∆∞u</button>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script>
        async function loadDiscounts() {
            if (!isLoggedIn() || !isAdmin()) { window.location.href = '/login.html'; return; }

            try {
                const discounts = await discountsAPI.getAll();
                document.getElementById('discounts-tbody').innerHTML = discounts.map(d => {
                    const expired = new Date(d.validTo) < new Date();
                    return `
            <tr>
              <td><strong>${d.code}</strong></td>
              <td>${d.percentage}%</td>
              <td>${d.usedCount}${d.usageLimit ? '/' + d.usageLimit : ''}</td>
              <td>${formatDate(d.validTo)}</td>
              <td><span class="badge ${d.active && !expired ? 'badge-delivered' : 'badge-cancelled'}">${d.active && !expired ? 'Ho·∫°t ƒë·ªông' : expired ? 'H·∫øt h·∫°n' : 'T·∫Øt'}</span></td>
              <td>
                <button class="btn btn-secondary" style="padding:0.25rem 0.5rem" onclick="editDiscount(${d.id})"><i class="fas fa-edit"></i></button>
                <button class="btn btn-danger" style="padding:0.25rem 0.5rem" onclick="deleteDiscount(${d.id})"><i class="fas fa-trash"></i></button>
              </td>
            </tr>
          `;
                }).join('') || '<tr><td colspan="6" style="text-align:center">Ch∆∞a c√≥ m√£ gi·∫£m gi√°</td></tr>';
            } catch (error) { showToast('L·ªói t·∫£i d·ªØ li·ªáu', 'error'); }
        }

        function showAddModal() {
            document.getElementById('modal-title').textContent = 'T·∫°o M√£ Gi·∫£m Gi√°';
            document.getElementById('discount-form').reset();
            document.getElementById('discount-id').value = '';
            document.getElementById('d-active').checked = true;
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 30);
            document.getElementById('d-expiry').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('discount-modal').classList.add('active');
            loadUsersForSelect();
        }

        async function loadUsersForSelect() {
            try {
                const response = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                const users = await response.json();
                document.getElementById('d-user').innerHTML = users.map(u =>
                    `<option value="${u.id}">${u.name} (${u.email})</option>`
                ).join('');
            } catch (e) { console.log('Load users failed'); }
        }

        function toggleUserSelect() {
            const type = document.getElementById('d-type').value;
            document.getElementById('user-select-group').style.display = type === 'user_specific' ? 'block' : 'none';
        }

        async function editDiscount(id) {
            try {
                const discounts = await discountsAPI.getAll();
                const d = discounts.find(x => x.id === id);
                if (!d) return;

                document.getElementById('modal-title').textContent = 'S·ª≠a M√£ Gi·∫£m Gi√°';
                document.getElementById('discount-id').value = id;
                document.getElementById('d-code').value = d.code;
                document.getElementById('d-percent').value = d.percentage;
                document.getElementById('d-min').value = d.minOrderValue || 0;
                document.getElementById('d-max').value = d.maxDiscount || '';
                document.getElementById('d-limit').value = d.usageLimit || '';
                document.getElementById('d-expiry').value = d.validTo ? new Date(d.validTo).toISOString().split('T')[0] : '';
                document.getElementById('d-type').value = d.type || 'public';
                document.getElementById('d-display').checked = d.displayOnHomepage || false;
                document.getElementById('d-notify').checked = false; // Don't re-notify on edit
                document.getElementById('d-active').checked = d.active;
                toggleUserSelect();
                loadUsersForSelect();
                if (d.assignedUserId) {
                    setTimeout(() => document.getElementById('d-user').value = d.assignedUserId, 100);
                }
                document.getElementById('discount-modal').classList.add('active');
            } catch (error) { showToast('L·ªói', 'error'); }
        }

        async function saveDiscount(e) {
            e.preventDefault();
            const id = document.getElementById('discount-id').value;
            const type = document.getElementById('d-type').value;
            const data = {
                code: document.getElementById('d-code').value.toUpperCase(),
                percentage: parseFloat(document.getElementById('d-percent').value),
                minOrderValue: parseFloat(document.getElementById('d-min').value) || 0,
                maxDiscount: parseFloat(document.getElementById('d-max').value) || null,
                usageLimit: parseInt(document.getElementById('d-limit').value) || null,
                validTo: document.getElementById('d-expiry').value || null,
                active: document.getElementById('d-active').checked,
                type,
                assignedUserId: type === 'user_specific' ? parseInt(document.getElementById('d-user').value) : null,
                displayOnHomepage: document.getElementById('d-display').checked,
                notifyUsers: document.getElementById('d-notify').checked
            };

            try {
                if (id) await discountsAPI.update(id, data);
                else await discountsAPI.create(data);
                showToast('L∆∞u th√†nh c√¥ng', 'success');
                closeModal();
                loadDiscounts();
            } catch (error) { showToast(error.message, 'error'); }
        }

        async function deleteDiscount(id) {
            if (!confirm('X√≥a m√£ n√†y?')) return;
            try {
                await discountsAPI.delete(id);
                showToast('ƒê√£ x√≥a', 'success');
                loadDiscounts();
            } catch (error) { showToast(error.message, 'error'); }
        }

        function closeModal() { document.getElementById('discount-modal').classList.remove('active'); }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('active'); }

        document.addEventListener('DOMContentLoaded', loadDiscounts);
        function toggleSidebar() {
            document.getElementById('admin-sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
    </script>
</body>

</html>
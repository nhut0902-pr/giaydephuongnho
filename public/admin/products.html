<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω S·∫£n Ph·∫©m - Admin</title>
    <link rel="icon" href="/favicon.jpg" type="image/jpeg">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="admin-layout">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside class="admin-sidebar" id="admin-sidebar">
            <div class="admin-logo">
                <span class="admin-close-btn" onclick="toggleSidebar()"
                    style="display:none;cursor:pointer;margin-right:10px"><i class="fas fa-times"></i></span>
                üëü Admin Panel
            </div>
            <nav class="admin-nav">
                <a href="/admin/"><i class="fas fa-chart-line"></i> Dashboard</a>
                <a href="/admin/orders.html"><i class="fas fa-shopping-cart"></i> ƒê∆°n H√†ng</a>
                <a href="/admin/products.html" class="active"><i class="fas fa-box"></i> S·∫£n Ph·∫©m</a>
                <a href="/admin/discounts.html"><i class="fas fa-tags"></i> M√£ Gi·∫£m Gi√°</a>
                <a href="/admin/flash-sale.html"><i class="fas fa-bolt"></i> Flash Sale</a>
                <a href="/admin/users.html"><i class="fas fa-users"></i> Ng∆∞·ªùi D√πng</a>
                <a href="/"><i class="fas fa-store"></i> Xem Shop</a>
                <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</a>
            </nav>
        </aside>

        <main class="admin-main">
            <div class="admin-header">
                <div style="display:flex;align-items:center">
                    <i class="fas fa-bars admin-toggle" onclick="toggleSidebar()" style="display:none"></i>
                    <h1>Qu·∫£n L√Ω S·∫£n Ph·∫©m</h1>
                </div>
                <button class="btn btn-primary" onclick="showAddModal()"><i class="fas fa-plus"></i> Th√™m S·∫£n
                    Ph·∫©m</button>
            </div>

            <div class="admin-table-container">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>H√¨nh</th>
                            <th>T√™n</th>
                            <th>Danh m·ª•c</th>
                            <th>Gi√°</th>
                            <th>Kho</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="product-modal" onclick="closeModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modal-title">Th√™m S·∫£n Ph·∫©m</h2><button class="modal-close" onclick="closeModal()"><i
                        class="fas fa-times"></i></button>
            </div>
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id">
                <div class="form-group"><label>T√™n s·∫£n ph·∫©m *</label><input type="text" id="p-name" required></div>
                <div class="form-group"><label>M√¥ t·∫£</label><textarea id="p-desc" rows="3"></textarea></div>
                <div class="form-group"><label>Gi√° (VNƒê) *</label><input type="number" id="p-price" required min="0">
                </div>

                <!-- Image Upload -->
                <div class="form-group">
                    <label>H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
                    <div style="display:flex;gap:1rem;align-items:center;margin-bottom:0.5rem">
                        <img id="p-image-preview" src="https://via.placeholder.com/100"
                            style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:2px dashed #ddd">
                        <div style="flex:1">
                            <input type="file" id="p-image-file" accept="image/*" style="display:none"
                                onchange="uploadImage(this)">
                            <button type="button" class="btn btn-secondary"
                                onclick="document.getElementById('p-image-file').click()" id="upload-btn">
                                <i class="fas fa-upload"></i> T·∫£i ·∫£nh l√™n
                            </button>
                            <p style="font-size:0.8rem;color:var(--gray);margin-top:0.5rem">Ho·∫∑c nh·∫≠p URL:</p>
                        </div>
                    </div>
                    <input type="url" id="p-image" placeholder="https://ik.imagekit.io/..."
                        onchange="previewUrl(this.value)">
                </div>

                <div class="form-group"><label>Danh m·ª•c</label>
                    <select id="p-category">
                        <option value="">Ch·ªçn danh m·ª•c</option>
                        <option value="sneaker">Sneaker</option>
                        <option value="sandal">Sandal</option>
                        <option value="sport">Th·ªÉ Thao</option>
                        <option value="heels">Cao G√≥t</option>
                        <option value="loafer">Gi√†y L∆∞·ªùi</option>
                    </select>
                </div>
                <div class="form-group"><label>S·ªë l∆∞·ª£ng kho</label><input type="number" id="p-stock" min="0" value="0">
                </div>

                <!-- Multiple Images Section -->
                <div class="form-group">
                    <label>Th∆∞ vi·ªán ·∫£nh s·∫£n ph·∫©m</label>
                    <div style="margin-bottom:1rem">
                        <input type="file" id="p-images-files" accept="image/*" multiple style="display:none" onchange="uploadMultipleImages(this)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('p-images-files').click()" id="upload-multiple-btn">
                            <i class="fas fa-images"></i> T·∫£i nhi·ªÅu ·∫£nh
                        </button>
                        <span style="font-size:0.8rem;color:var(--gray);margin-left:1rem">T·ªëi ƒëa 10 ·∫£nh</span>
                    </div>
                    <div id="images-gallery" class="images-gallery">
                        <!-- Multiple images will be displayed here -->
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block">L∆∞u</button>
            </form>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script>
        async function loadProducts() {
            if (!isLoggedIn() || !isAdmin()) { window.location.href = '/login.html'; return; }

            try {
                const products = await productsAPI.getAll();
                document.getElementById('products-tbody').innerHTML = products.map(p => `
          <tr>
            <td>
              <img src="${p.image || 'https://via.placeholder.com/50'}" alt="${p.name}">
              ${p.images && p.images.length > 0 ? `
                <div class="product-images-preview">
                  ${p.images.slice(0, 3).map(img => `<img src="${img.url}" alt="Gallery">`).join('')}
                  ${p.images.length > 3 ? `<span style="font-size:0.7rem;color:var(--gray)">+${p.images.length - 3}</span>` : ''}
                </div>
              ` : ''}
            </td>
            <td>${p.name}</td>
            <td>${p.category || '-'}</td>
            <td>${formatPrice(p.price)}</td>
            <td>${p.stock}</td>
            <td>
              <button class="btn btn-secondary" style="padding:0.25rem 0.5rem" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i></button>
              <button class="btn btn-danger" style="padding:0.25rem 0.5rem" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('') || '<tr><td colspan="6" style="text-align:center">Ch∆∞a c√≥ s·∫£n ph·∫©m</td></tr>';
            } catch (error) { showToast('L·ªói t·∫£i s·∫£n ph·∫©m', 'error'); }
        }

        function showAddModal() {
            document.getElementById('modal-title').textContent = 'Th√™m S·∫£n Ph·∫©m';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            productImages = []; // Reset images
            renderImagesGallery();
            document.getElementById('product-modal').classList.add('active');
        }

        async function editProduct(id) {
            try {
                const p = await productsAPI.getById(id);
                document.getElementById('modal-title').textContent = 'S·ª≠a S·∫£n Ph·∫©m';
                document.getElementById('product-id').value = id;
                document.getElementById('p-name').value = p.name;
                document.getElementById('p-desc').value = p.description || '';
                document.getElementById('p-price').value = p.price;
                document.getElementById('p-image').value = p.image || '';
                document.getElementById('p-category').value = p.category || '';
                document.getElementById('p-stock').value = p.stock;
                
                // Load existing images
                productImages = p.images || [];
                renderImagesGallery();
                
                document.getElementById('product-modal').classList.add('active');
            } catch (error) { showToast('L·ªói', 'error'); }
        }

        async function saveProduct(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const data = {
                name: document.getElementById('p-name').value,
                description: document.getElementById('p-desc').value,
                price: parseFloat(document.getElementById('p-price').value),
                image: document.getElementById('p-image').value,
                images: productImages.map(img => ({ url: img.url, fileId: img.fileId })),
                category: document.getElementById('p-category').value,
                stock: parseInt(document.getElementById('p-stock').value) || 0
            };

            try {
                if (id) await productsAPI.update(id, data);
                else await productsAPI.create(data);
                showToast('L∆∞u th√†nh c√¥ng', 'success');
                closeModal();
                loadProducts();
            } catch (error) { showToast(error.message, 'error'); }
        }

        async function deleteProduct(id) {
            if (!confirm('X√≥a s·∫£n ph·∫©m n√†y?')) return;
            try {
                await productsAPI.delete(id);
                showToast('ƒê√£ x√≥a', 'success');
                loadProducts();
            } catch (error) { showToast(error.message, 'error'); }
        }

        function closeModal() { document.getElementById('product-modal').classList.remove('active'); }

        // Image upload to ImageKit
        async function uploadImage(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const btn = document.getElementById('upload-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...';
            btn.disabled = true;

            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/admin/upload', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });

                const data = await response.json();
                if (data.url) {
                    document.getElementById('p-image').value = data.url;
                    document.getElementById('p-image-preview').src = data.url;
                    showToast('T·∫£i ·∫£nh th√†nh c√¥ng!', 'success');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                showToast('L·ªói t·∫£i ·∫£nh: ' + error.message, 'error');
            } finally {
                btn.innerHTML = '<i class="fas fa-upload"></i> T·∫£i ·∫£nh l√™n';
                btn.disabled = false;
            }
        }

        function previewUrl(url) {
            if (url) document.getElementById('p-image-preview').src = url;
        }

        // Multiple images functionality
        let productImages = [];

        async function uploadMultipleImages(input) {
            if (!input.files || input.files.length === 0) return;

            const btn = document.getElementById('upload-multiple-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i...';
            btn.disabled = true;

            const formData = new FormData();
            Array.from(input.files).forEach(file => {
                formData.append('images', file);
            });

            try {
                const response = await fetch('/api/admin/upload-multiple', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                    body: formData
                });

                const data = await response.json();
                if (data.success && data.images) {
                    productImages = [...productImages, ...data.images];
                    renderImagesGallery();
                    showToast(`ƒê√£ t·∫£i ${data.images.length} ·∫£nh th√†nh c√¥ng!`, 'success');
                } else {
                    throw new Error(data.error || 'Upload failed');
                }
            } catch (error) {
                showToast('L·ªói t·∫£i ·∫£nh: ' + error.message, 'error');
            } finally {
                btn.innerHTML = '<i class="fas fa-images"></i> T·∫£i nhi·ªÅu ·∫£nh';
                btn.disabled = false;
                input.value = ''; // Reset input
            }
        }

        function renderImagesGallery() {
            const gallery = document.getElementById('images-gallery');
            gallery.innerHTML = productImages.map((img, index) => `
                <div class="image-item" style="position:relative;display:inline-block;margin:0.5rem">
                    <img src="${img.url}" style="width:100px;height:100px;object-fit:cover;border-radius:8px;border:2px solid #ddd">
                    <button type="button" onclick="removeImage(${index})" 
                            style="position:absolute;top:-8px;right:-8px;background:var(--danger);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:12px">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        async function removeImage(index) {
            const image = productImages[index];
            try {
                // Delete from ImageKit if it has fileId
                if (image.fileId) {
                    await fetch(`/api/admin/delete-image/${image.fileId}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                }
                productImages.splice(index, 1);
                renderImagesGallery();
                showToast('ƒê√£ x√≥a ·∫£nh', 'success');
            } catch (error) {
                showToast('L·ªói x√≥a ·∫£nh: ' + error.message, 'error');
            }
        }

        function closeModal() { 
            document.getElementById('product-modal').classList.remove('active');
            productImages = []; // Reset images when closing modal
        }
        function closeDeleteModal() { document.getElementById('delete-modal').classList.remove('active'); }

        document.addEventListener('DOMContentLoaded', loadProducts);
        function toggleSidebar() {
            document.getElementById('admin-sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }
    </script>
</body>

</html>
```
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n H√†ng - Gi√†y D√©p H∆∞∆°ng Nh·ªõ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo"><span class="logo-icon">üëü</span><span>Gi√†y D√©p H∆∞∆°ng Nh·ªõ</span></a>
            <nav class="nav"><a href="/">Trang Ch·ªß</a><a href="/products.html">S·∫£n Ph·∫©m</a></nav>
            <div class="header-actions">
                <button class="cart-btn" onclick="toggleCart()"><i class="fas fa-shopping-bag"></i><span
                        class="cart-count" id="cart-count">0</span></button>
                <div id="auth-section"></div>
            </div>
        </div>
    </header>

    <div class="page-header">
        <h1><i class="fas fa-box"></i> ƒê∆°n H√†ng C·ªßa T√¥i</h1>
    </div>

    <div class="orders-list" id="orders-list">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-bag"></i> Gi·ªè H√†ng</h3><button class="modal-close" onclick="toggleCart()"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="cart-items" id="cart-items"></div>
        <div class="cart-footer">
            <div class="cart-total"><span>T·ªïng:</span><span id="cart-total">0ƒë</span></div><a href="/cart.html"
                class="btn btn-primary btn-block">Xem Gi·ªè H√†ng</a>
        </div>
    </div>
    <div class="modal-overlay" id="cart-overlay" onclick="toggleCart()"></div>
    <div class="toast-container" id="toast-container"></div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/main.js"></script>
    <script>
        const statusLabels = {
            pending: 'Ch·ªù x√°c nh·∫≠n',
            processing: 'ƒêang x·ª≠ l√Ω',
            shipped: 'ƒêang giao',
            delivered: 'ƒê√£ giao',
            cancelled: 'ƒê√£ h·ªßy'
        };

        async function loadOrders() {
            if (!isLoggedIn()) {
                sessionStorage.setItem('redirectAfterLogin', '/orders.html');
                window.location.href = '/login.html';
                return;
            }

            const container = document.getElementById('orders-list');

            try {
                const orders = await ordersAPI.getAll();

                if (orders.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><h3>Ch∆∞a c√≥ ƒë∆°n h√†ng</h3><p>H√£y mua s·∫Øm ngay!</p><a href="/products.html" class="btn btn-primary">Xem s·∫£n ph·∫©m</a></div>';
                    return;
                }

                container.innerHTML = orders.map(order => `
          <div class="order-card">
            <div class="order-header">
              <div>
                <span class="order-id">ƒê∆°n h√†ng #${order.id}</span>
                <span class="order-date" style="margin-left:1rem">${formatDate(order.createdAt)}</span>
              </div>
              <span class="order-status status-${order.status}">${statusLabels[order.status]}</span>
            </div>
            <div class="order-body">
              <div class="order-items">
                ${order.OrderItems.map(item => `
                  <div class="order-item">
                    <div class="order-item-image"><img src="${item.productImage || ''}" alt="${item.productName}"></div>
                    <div style="flex:1">
                      <div style="font-weight:500">${item.productName}</div>
                      <div style="color:var(--gray)">SL: ${item.quantity} x ${formatPrice(item.price)}</div>
                    </div>
                    <div style="font-weight:600">${formatPrice(item.quantity * item.price)}</div>
                  </div>
                `).join('')}
              </div>
              ${order.discount > 0 ? `<div style="color:var(--success);margin-bottom:0.5rem">Gi·∫£m gi√°: -${formatPrice(order.discount)}</div>` : ''}
              <div class="order-total">
                <span>T·ªïng c·ªông:</span>
                <span style="color:var(--primary-dark)">${formatPrice(order.total)}</span>
              </div>
              ${order.status === 'pending' ? `<button class="btn btn-danger" style="margin-top:1rem" onclick="cancelOrder(${order.id})"><i class="fas fa-times"></i> H·ªßy ƒë∆°n</button>` : ''}
            </div>
          </div>
        `).join('');
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>L·ªói t·∫£i ƒë∆°n h√†ng</h3></div>';
            }
        }

        async function cancelOrder(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?')) return;
            try {
                await ordersAPI.cancel(id);
                showToast('ƒê√£ h·ªßy ƒë∆°n h√†ng', 'success');
                loadOrders();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>

</html>
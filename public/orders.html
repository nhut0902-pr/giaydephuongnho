<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn Hàng - Giày Dép Hương Nhớ</title>
    <link rel="icon" href="/favicon.jpg" type="image/jpeg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header class="header">
        <div class="header-container">
            <a href="/" class="logo"><img src="images/logo.jpg" alt="Giày Dép Hương Nhớ"></a>
            <nav class="nav"><a href="/">Trang Chủ</a><a href="/products.html">Sản Phẩm</a></nav>
            <div class="header-actions">
                <button class="cart-btn" onclick="toggleCart()"><i class="fas fa-shopping-bag"></i><span
                        class="cart-count" id="cart-count">0</span></button>
                <div id="auth-section"></div>
            </div>
        </div>
    </header>

    <div class="page-header">
        <h1><i class="fas fa-box"></i> Đơn Hàng Của Tôi</h1>
    </div>

    <div class="orders-list" id="orders-list">
        <div class="loading">
            <div class="spinner"></div>
        </div>
    </div>

    <div class="cart-sidebar" id="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fas fa-shopping-bag"></i> Giỏ Hàng</h3><button class="modal-close" onclick="toggleCart()"><i
                    class="fas fa-times"></i></button>
        </div>
        <div class="cart-items" id="cart-items"></div>
        <div class="cart-footer">
            <div class="cart-total"><span>Tổng:</span><span id="cart-total">0đ</span></div><a href="/cart.html"
                class="btn btn-primary btn-block">Xem Giỏ Hàng</a>
        </div>
    </div>
    <div class="modal-overlay" id="cart-overlay" onclick="toggleCart()"></div>
    <div class="toast-container" id="toast-container"></div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/main.js"></script>
    <script>
        const statusLabels = {
            pending: 'Chờ xác nhận',
            processing: 'Đang xử lý',
            shipped: 'Đang giao',
            delivered: 'Đã giao',
            cancelled: 'Đã hủy'
        };

        async function loadOrders() {
            if (!isLoggedIn()) {
                sessionStorage.setItem('redirectAfterLogin', '/orders.html');
                window.location.href = '/login.html';
                return;
            }

            const container = document.getElementById('orders-list');

            try {
                const orders = await ordersAPI.getAll();

                if (orders.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-box-open"></i><h3>Chưa có đơn hàng</h3><p>Hãy mua sắm ngay!</p><a href="/products.html" class="btn btn-primary">Xem sản phẩm</a></div>';
                    return;
                }

                container.innerHTML = orders.map(order => `
          <div class="order-card">
            <div class="order-header">
              <div>
                <span class="order-id">Đơn hàng #${order.id}</span>
                <span class="order-date" style="margin-left:1rem">${formatDate(order.createdAt)}</span>
              </div>
              <span class="order-status status-${order.status}">${statusLabels[order.status]}</span>
            </div>
            <div class="order-body">
              <div class="order-items">
                ${order.OrderItems.map(item => `
                  <div class="order-item">
                    <div class="order-item-image"><img src="${item.productImage || ''}" alt="${item.productName}"></div>
                    <div style="flex:1">
                      <div style="font-weight:500">${item.productName}</div>
                      <div style="color:var(--gray)">SL: ${item.quantity} x ${formatPrice(item.price)}</div>
                    </div>
                    <div style="font-weight:600">${formatPrice(item.quantity * item.price)}</div>
                  </div>
                `).join('')}
              </div>
              ${order.discount > 0 ? `<div style="color:var(--success);margin-bottom:0.5rem">Giảm giá: -${formatPrice(order.discount)}</div>` : ''}
              <div class="order-total">
                <span>Tổng cộng:</span>
                <span style="color:var(--primary-dark)">${formatPrice(order.total)}</span>
              </div>
              <div style="margin-top:1rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                ${order.status === 'pending' ? `<button class="btn btn-danger" onclick="cancelOrder(${order.id})"><i class="fas fa-times"></i> Hủy đơn</button>` : ''}
                <button class="btn btn-secondary" onclick="downloadInvoice(${order.id})"><i class="fas fa-file-pdf"></i> Tải hóa đơn</button>
              </div>
            </div>
          </div>
        `).join('');
            } catch (error) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><h3>Lỗi tải đơn hàng</h3></div>';
            }
        }

        async function cancelOrder(id) {
            if (!confirm('Bạn có chắc muốn hủy đơn hàng này?')) return;
            try {
                await ordersAPI.cancel(id);
                showToast('Đã hủy đơn hàng', 'success');
                loadOrders();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function downloadInvoice(orderId) {
            const token = localStorage.getItem('token');
            // Open in new window with auth header via form submission
            const link = document.createElement('a');
            link.href = `/api/invoice/${orderId}?token=${token}`;
            link.download = `hoadon-${orderId}.pdf`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Đang tải hóa đơn...', 'success');
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>

</html>